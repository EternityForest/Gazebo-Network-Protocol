<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=windows-1252">
	<TITLE>Gazebo Protocol Version 0.71.6</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.3  (Win32)">
	<META NAME="AUTHOR" CONTENT="Daniel Black">
	<META NAME="CREATED" CONTENT="20130306;1423267">
	<META NAME="CHANGEDBY" CONTENT="Daniel Black">
	<META NAME="CHANGED" CONTENT="20130322;10275154">
	<STYLE TYPE="text/css">
	<!--
		@page { margin: 0.79in }
		P { margin-bottom: 0.08in; widows: 2; orphans: 2; page-break-before: auto; page-break-after: auto }
		P.western { font-family: "Linux Libertine" }
		H1 { margin-bottom: 0.08in; text-align: center; widows: 2; orphans: 2; page-break-before: auto }
		H1.western { font-family: "Quivira", serif; font-weight: normal }
		H1.cjk { font-family: "SimSun" }
		H1.ctl { font-family: "Mangal" }
		H2 { margin-bottom: 0.08in; text-align: center; widows: 2; orphans: 2; page-break-before: auto }
		H2.western { font-family: "Quivira", serif; font-size: 20pt; font-weight: normal }
		H2.cjk { font-family: "SimSun" }
		H2.ctl { font-family: "Mangal" }
		H3 { margin-bottom: 0.08in; background: #c0c0c0; border: 1px solid #000000; padding: 0.02in; text-align: left; widows: 2; orphans: 2; page-break-before: auto }
		H3.western { font-family: "Quivira", serif; font-weight: normal }
		H3.cjk { font-family: "SimSun" }
		H3.ctl { font-family: "Mangal" }
		H4 { margin-bottom: 0.08in; background: #e6e6e6; border: 1px solid #000000; padding: 0.02in; text-align: left; widows: 2; orphans: 2; page-break-before: auto }
		H4.western { font-family: "Quivira", serif; font-weight: normal }
		H4.cjk { font-family: "SimSun" }
		H4.ctl { font-family: "Mangal" }
		H5 { margin-bottom: 0.08in; text-align: left; widows: 2; orphans: 2; page-break-before: auto }
		H5.cjk { font-family: "SimSun" }
		H5.ctl { font-family: "Mangal" }
		P.nontechnical-western { font-family: "Linux Libertine"; text-align: justify }
		P.nontechnical-cjk { text-align: justify }
		P.nontechnical-ctl { text-align: justify }
		CODE.cjk { font-family: "NSimSun", monospace }
		A:link { so-language: zxx }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<DIV TYPE=HEADER>
	<P ALIGN=LEFT STYLE="margin-bottom: 0.2in; page-break-after: auto"><SDFIELD TYPE=DOCINFO SUBTYPE=TITLE>Gazebo Protocol Version 0.71.6</SDFIELD>
	<FONT FACE="Linux Libertine">by </FONT><FONT FACE="Linux Libertine"><SDFIELD TYPE=DOCINFO SUBTYPE=CREATE FORMAT=AUTHOR>Daniel Black</SDFIELD></FONT><FONT FACE="Cardinal">	</FONT>	Page
	<SDFIELD TYPE=PAGE SUBTYPE=RANDOM FORMAT=PAGE>35</SDFIELD> of <SDFIELD TYPE=DOCSTAT SUBTYPE=PAGE FORMAT=PAGE>35</SDFIELD></P>
</DIV>
<H1 CLASS="western">Gazebo Protocol Specification</H1>
<P ALIGN=CENTER STYLE="margin-bottom: 0in; page-break-after: auto"><FONT FACE="Courier New, monospace"><FONT SIZE=2>&copy;
 2013 Daniel Black.<BR>Version 0.71.6<BR>This work is licensed under
a Creative Commons Attribution 3.0 Unported License.</FONT></FONT></P>
<H2 CLASS="western">Introduction and Statement of Purpose</H2>
<P CLASS="nontechnical-western">In many electronics applications
there is a need for devices to communicate with each other. Often
this is accomplished via a proprietary application layer running on a
semi-standard link layer. Often much manual setup is required, e.g.
entering device addresses, writing custom drivers, etc. Another
problem is that devices are often incompatible with each other and
cannot share a physical layer, or require certain physical data lines
to be exclusive to one device.</P>
<P CLASS="nontechnical-western">Gazebo aims to correct these problems
by defining a protocol that runs on common, existing physical layers,
does not require the purchase of any developer license or unique
codes, allows device to share a common bus, allows devices to be
discovered with manual addressing, and allows devices to be
self-documenting.</P>
<P CLASS="nontechnical-western">Gazebo does not require custom
hardware nor does it require excessive CPU resources. It runs over
common RS485, USB,or TTL interfaces and the software is freely
available. Gazebo was designed not to require devices to have any
user interface(DIP switch, etc) at all, an important concern for
small sensors and the like.</P>
<P CLASS="nontechnical-western">Gazebo has native support for things
like units of measure, data types (Including compound data types)
remote function calls, nonvolatile configurations, and defines ways
to ask questions about devices. Without human intervention the master
can enumerate the devices on the bus, discover their capabilities,
and issue commands.</P>
<P CLASS="nontechnical-western">Gazebo is general purpose and is not
specific to any industry. It was designed to allow devices to expose
very generic functionality in a uniform way. Gazebo is not limited to
any predefined list of device types.</P>
<P CLASS="nontechnical-western">The core concept in Gazebo is the
Parameter. A parameter is a variable that a device exposes to the
network. Parameters may support read and write operations, and every
parameter has associated metadata that may be requested from the
device.</P>
<P CLASS="nontechnical-western">Parameters are not limited to simple
variables, as both writes and reads may have side effects, and read
requests may carry arguments, making them equivalent to function
calls. Gazebo defines a mechanism for asking if a read or write will
have side effects.</P>
<P CLASS="nontechnical-western">The concept of Objects is supported
in a lightweight manner through Grouping. Parameters may be grouped
together, and every group is an instance of a group class. In effect
this allows anyone to effectively extend the standard by publishing
an API as a group class and giving that class a unique name.</P>
<P CLASS="nontechnical-western">A side effect of this is that we can
do away with .&quot;device classes&quot; and the like, because
instead of looking for devices of a specific class, we can instead
look for devices that implement a specific class.</P>
<P CLASS="nontechnical-western">Gazebo specifies native support for
Error responses. While Gazebo was not designed for mission-critical
systems, reliability was a large concern in the design of the
protocol. Small timing errors in gazebo data will not affect
operation, nor is it possible for a string of bytes from noise to
lock up the protocol decoder state. CRCs are used on all packets
except for one-byte acknowledgments and Boolean responses, and data
is to some degree self-synchronizing due to the use of packet start
codes and length fields. In addition to CRCs, runtime validation is
performed and attempting to write the wrong number of bytes to a
parameter, perform an operation on a nonexistent parameter, or
perform an invalid operation will result in an error. In addition,
application code may perform additional validation on the data and
return a standard error packet if anything is amiss.</P>
<P CLASS="nontechnical-western">For these reasons, it is believed
that Gazebo is a viable protocol for use in the fields of lighting
control, process automation for non-critical equipment,
entertainment, device configuration, scientific monitoring, and
general embedded communication.</P>
<DIV ID="Table of Contents1" DIR="LTR">
	<DIV ID="Table of Contents1_Head" DIR="LTR">
		<P ALIGN=LEFT STYLE="margin-top: 0.17in; page-break-after: avoid"><FONT FACE="Quivira, serif"><FONT SIZE=4 STYLE="font-size: 16pt"><B>Table
		of Contents</B></FONT></FONT></P>
	</DIV>
	<P STYLE="margin-bottom: 0in; page-break-after: auto">Gazebo
	Protocol Specification	1</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Introduction and Statement of Purpose	1</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	About this Document	3</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Basic Concepts	4</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Physical Layer	7</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Packet Format	8</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Timing and Delimiting rules	10</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Slave Properties	11</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Addressing	11</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Supported Baud Rates	12</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Valid Packet Types	12</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Error Codes	18</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Slave Description String	19</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Parameter Description String	21</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Data Types	25</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Standard Information Broadcast Identifiers	27</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Additional Attributes	30</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Rate Format Strings	30</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Naming of Interpretations	30</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Reliability Concerns	31</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Modbus Compatibility	32</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Labeling	32</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Naming Conventions	33</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Device Documentation Conventions	33</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Design Patterns and Solutions	33</P>
	<P STYLE="margin-left: 0.2in; margin-bottom: 0in; page-break-after: auto">
	Glossary	35</P>
</DIV>
<P CLASS="western"><BR><BR>
</P>
<H2 CLASS="western">About this Document</H2>
<H3 CLASS="western">Definition of the Protocol</H3>
<P CLASS="western">The protocol is to be considered as defined by
this document and not by any reference implementation.</P>
<H3 CLASS="western">Assumed Knowledge</H3>
<P CLASS="western">It is assumed that the reader is familiar with
basic electronics and computer science, and with common standards.
This document will attempt not to reference anything that could not
be researched with a simple internet search.</P>
<H3 CLASS="western">Build Process</H3>
<P CLASS="western">The document is edited as a Wiki Markup text file.
It is then converted to various presentation formats. Only formatting
and minor additions like page numbers and tables of contents are made
after the Wiki Markup stage. In the case of any conflict, the Wiki
Markup Source should be considered the definitive version.</P>
<H3 CLASS="western">Conventions Used</H3>
<P CLASS="western">All numbers are to be interpreted as decimal
unless preceded by '0x' in which case they are hex. Section numbering
is not used in light of the modern trend towards e-book reading and
searchability. Sections numbers are only used to express numbered
lists where the number is important. References to other sections in
this document are italicized.</P>
<H3 CLASS="western">Version Numbers</H3>
<H4 CLASS="western">Major</H4>
<P CLASS="western">The major revision number indicates a stable
release this version is based on. A major release is made when the
current specification is stable. Every Major release will attempt to
be backwards compatible with every previous Major release. You should
design devices to comply with the most recent major release unless a)
the device has user-upgradable firmware, or b) the device does not
have the hardware resources to support the current version. In that
case a previous major version should be used.</P>
<P CLASS="western">Note that every version before V1.0 should be
considered an experimental version, and backward compatibility may
not exist with pre-1.0 versions.</P>
<H4 CLASS="western">Minor</H4>
<P CLASS="western">The minor revision number indicates a change that
modifies a feature. Features added since the last Major revision
should be considered unstable.</P>
<H4 CLASS="western">Trivial</H4>
<P CLASS="western">The final part of the minor revision number
indicates changes to the text that do not alter the actual protocol
but instead clarify or improve wording.</P>
<H3 CLASS="western">Must and Should</H3>
<P CLASS="western">As used in this document, &quot;must&quot;
indicates an absolute requirement without which devices are not
considered to be compliant. &quot;should&quot; indicates a
requirement that may be ignored if engineering practicalities do not
allow it to be implemented, but otherwise should not be ignored and
should not be considered unimportant.</P>
<H2 CLASS="western">Basic Concepts</H2>
<H3 CLASS="western">Master-Slave</H3>
<P CLASS="western">The protocol is master-slave, with all
transactions being initiated by the master. Here a &quot;Transaction&quot;
refers to one complete operation, such as a write or read, and
consists of one packet sent by the master and optionally one packet
sent in response. This eliminates complex arbitration protocols.</P>
<H3 CLASS="western">Addressing</H3>
<P CLASS="western">Slaves all have a fixed 128 bit UUID. The master
may conduct a binary search algorithm to find all devices, and then
assign temporary 16 bit addresses to nodes to eliminate the overhead
of such a large address space. 
</P>
<P CLASS="western">This binary search period is the only time when
there is a possibility of nodes colliding, and collisions are
acceptable because the presence of any data at all is what the master
looks for, even if it contains framing errors. This does however
depend on the master being able to detect bytes even if framing
errors are present. However this appears to be the standard behavior.</P>
<P CLASS="western">UUIDs are not required to conform to any standard
and may simply be random numbers. Care should be taken to ensure that
UUIDs are generated with sufficient entropy.</P>
<H3 CLASS="western">Parameters</H3>
<P CLASS="western">Each slave device has a set of <EM>parameters </EM>that
may be readable and/or writable by the master. Each parameter is
associated with a <EM>type </EM>which is similar to standard
programming concepts of type.</P>
<P CLASS="western">Parameters also have an <EM>interpretation, </EM>which
gives meaning to the value of the parameter, either by specifying a
unit of measure o a data format. Interpretations are named in a
specified manner with preference given to SI names as outlined in
Naming of Interpretations. 
</P>
<P CLASS="western">Parameters may also have a list of Arguments
passed when reading to allow exposing a function. In that case the
arguments would all have a name, a type, and an interpretation,
allowing for some degree of self documentation even for function
calls.</P>
<P CLASS="western">Devices are <EM>not required </EM>to accept write
requests and may <EM>optionally</EM> return an error message if a
slave attempts to write an invalid datum to a parameter even if it is
formatted correctly e.g. writing an out of range value to a numeric
variable.</P>
<P CLASS="western">Each parameter has a name, and a device cannot
have two parameters with the same name.</P>
<P CLASS="western">Parameters are numbered from 0 to the index of the
highest parameter. Parameters must be numbered sequentially.</P>
<P CLASS="western">A devices parameter set should be considered <EM>bound
</EM>to it's UUID. If any firmware update changes it's interface,
than it should get a new UUID, and is considered a new device.</P>
<H3 CLASS="western">Grouping</H3>
<P CLASS="western">Parameters may be <EM>grouped </EM>together, and
every group is an instance of a group class. Groups allow lightweight
object-like behavior without impacting slave performance. 
</P>
<P CLASS="western">Groups are entirely implemented in stored metadata
on the slave, and the slave firmware need not have any further
understanding of groups. Likewise the master may ignore the group
metadata. 
</P>
<P CLASS="western">Every group instance has a name and a slave may
not have two groups with the same name.</P>
<P CLASS="western">Grouped parameters have an associated <EM>Group
Role, </EM>such as 'Shuffle' in a group representing a virtual deck
of cards. 
</P>
<P CLASS="western">Anyone may create an <EM>Interface </EM>by
publishing an <EM>Interface Specification</EM> defining a compliant
group.<BR>Such groups should have Class names of the form
&quot;&lt;Base64UUID&gt;_&lt;Whatever&gt;&quot;. Well known
organizations may use their organization name instead of the UUID.</P>
<P CLASS="western">Group Class names may not begin with the asterisk
as that is reserved. Groups intended for one-off use(not intended as
a public standard) are not required to have UUIDs or organization
names.</P>
<P CLASS="western">Allowing unique user-defined group classes allows,
for example, a maker of challenge-response tokens to publish a
standard for the &quot;kr97bc5Lm7BBnjkiHjr_Token&quot;. Now anyone
can make a challenge-response token that is compatible with all the
existing devices. Someone could make an upgraded version, say, that
also serves as a digital signature device. They could implement the
digital signature device as a separate group, and have backwards
compatibility.</P>
<H3 CLASS="western">Profiles</H3>
<P CLASS="western">Slave devices do not have &quot;device profiles&quot;
as a device profile can easily be replaced with a group class. Group
classes may be more flexible in that they allow a device to implement
multiple inheritance simple by implementing two distinct group
classes without resorting to ideas of multiple endpoints.</P>
<H3 CLASS="western">Multicasting</H3>
<P CLASS="western">broadcasting and multicast addressing is an
integral part of the protocol, and at any time the master may command
a device to join a group or quit a group. Group addresses are taken
from the same address space as any other address, and slaves must
take the same action when given a multicast command as they would
when given a direct request. All slaves must be able to listen to at
least 4 groups addresses.</P>
<H3 CLASS="western">Error Reporting</H3>
<P CLASS="western">A slave may respond to any request with an Slave
Error Packet.<BR>Slave Error Packets contain a one byte error code,
which is to be interpreted as per the table in <EM>Error Codes.</EM><BR>Slave
error codes may also contain an arbitrary null-terminated UTF-8
string of additional information.</P>
<P CLASS="western">Slaves should implement as many error checks as is
practical.<BR>Slaves that do not have the resources to return
specific errors can return error 0(generic error) in place of any
other error message, but this is to be avoided where possible.</P>
<H3 CLASS="western">Information Broadcasting</H3>
<P CLASS="western">Information Broadcasting is a way to send
information to a group of slaves, all slaves, or one slave without
knowing anything about the slaves an without depending on the
numbering of their parameters.</P>
<P CLASS="western">Every information Broadcast contains a Key, which
is an 8 character description of the broadcast, such as Year for the
number o the current year. The rest of the information broadcast
contains up to 240 characters of data.</P>
<P CLASS="western">The purpose of this is to have a standard way of
sending data to many different slaves at once, even if they have
different numbering for their parameters. Any slave may ignore an
information broadcast, and since they are standard packets, you can
send them to one slave, a group of slaves, or all slaves because of
Gazebo's flexible addressing.</P>
<H3 CLASS="western">Scalability</H3>
<P CLASS="western">Gazebo provides the main protocol, which is
already very easy to implement, and the Small Gazebo subset which
does not even require devices be able to communicate back. Small
Gazebo only uses the reserved address range 0 256-512, and the
broadcast address.<BR>In small gazebo, all commands except for
writing data to a parameter and reading from a parameter are
optional.</P>
<H3 CLASS="western">Sanity Checking</H3>
<P CLASS="western">A central theme in Gazebo is sanity checking.
Error messages are provided not only for protocol level errors like
writing to an invalid parameter, but also general Application Level
errors, such as writing an invalid sequence to a byte array that must
conform to a format. Device developers are encouraged to sanity check
all incoming data. Not only does this increase reliability but it
makes development easier, because programmers can see exactly what
commands are invalid and why.</P>
<H3 CLASS="western">Endianness</H3>
<P CLASS="western">All data with the exception of the CRC is always
sent little-endian, because it is the more common transmission.<BR>The
CRC is always sent big-endian. 
</P>
<H2 CLASS="western">Physical Layer</H2>
<P CLASS="western">The protocol defines several possible physical
layers. Each physical layer defines connectors, voltage levels, and
power may be carried alongside in all of them. All three layers are
intercompatible with very simple adapters.</P>
<H3 CLASS="western">Gazebo-USB</H3>
<P CLASS="western">A point-to-point version of Gazebo tunneled over a
virtual COM port connection using the standard USB-CDC class. One
advantage of Gazebo-USB is that from the software's point of view it
is identical to talking to a RS485 Gazebo device through a serial
adapter. The device should present itself as 8-N-1 Serial, and baud
rate commands should be ignored as USB serial has no baud rate in the
traditional sense.</P>
<P CLASS="western">To avoid failure, any software that acts as a
master on a computer that is no</P>
<H3 CLASS="western">Gazebo-RS485</H3>
<P CLASS="western">8-N-1 RS485 Idle high non-inverted data carried
along with power using RJ-11 connectors with the pinout shown in the
below table. The working voltage is 9-24V and all devices must handle
a 30V continual over-voltage. Devices should remain functional at 30V
but are not required to. All devices must hot plug to 24V through
30uH+2Ohms and 300uH+20ohms without damage. Devices are not required
to hot-plug to 30V. Devices should be designed to survive up to 37V
applied to either RS485 data line.</P>
<P CLASS="western">All devices supplying power must be designed in
such a way that a short circuit will not cause a dangerous fault or
permanent circuit damage. Devices supplying power must not create any
dangerous condition when two or more are connected to the same bus.
Devices supplying power should be clearly labeled as to their voltage
and current, and should include a warning against hot plugging if
they supply more than 30V.</P>
<P CLASS="western">No device may draw more than 1A from the network
no matter what the voltage, although the total loading is limited by
voltage drop and cable ampacity.</P>
<P CLASS="western">The network bus ground must remain isolated from
any earth ground at all times.</P>
<P CLASS="western">Devices requiring more than ~4W should have an
external power connector, which <EM>should</EM> take a voltage in the
range of 7-30V but may take any voltage. Where possible cables should
be made using 22 Gauge copper stranded wire, twisted pair. Devices
should use a transceiver with the slowest slew rate that will still
support their highest baud rate. The RS485 bus should use failsafe
pullups at one terminator.</P>
<P CLASS="western">All &quot;crowbar&quot; type surge protection
devices must not conduct at 30V as 30V should be considered a routine
</P>
<H4 CLASS="western">Pinout</H4>
<P CLASS="western">The pin ordering of of the rj11(using common rj11
numbering) is to be:</P>
<P CLASS="western">5=GND<BR>4=A<BR>3=B<BR>2=PWR</P>
<H3 CLASS="western">Gazebo-TTL</H3>
<P CLASS="western">8-N-1 Idle high non-inverted data carried over a
shared TTL wire pulled high to 5V via no less than 1k via any
connector. Should power be carried alongside the voltage should be
5V.</P>
<H2 CLASS="western">Packet Format</H2>
<P CLASS="western">The protocol defines two types of packet, <EM>Standard</EM>
and <EM>Short</EM>.<BR>A Standard Packet complies with the below
format while a short packet is simply an arbitrary byte sequence that
may include ACK, and ASCII 0 to F.</P>
<P CLASS="western">Packets are described in terms of bytes
transmitted over an arbitrary medium.</P>
<H3 CLASS="western">Standard Packets are to be of the form</H3>
<P CLASS="western">(In order from first transmitted at the top to
last transmitted at the bottom)</P>
<P CLASS="western">[8 bits fixed preamble that must be 0x55] <BR>[8
bit Packet-Type ]<BR>[16 bit Address ]<BR>[8 bit Length ]<BR>[0-240
bytes Data Payload ] <BR>[16 bit CRC16 ]</P>
<P CLASS="western">For a total overhead of 70 bits per packet
accounting for start and stop bits.</P>
<P CLASS="western">The exception to this rule is Short Packets such
as Slave Presence Response, ACK packets, and other packets which are
a single byte or a series of bytes not including the 0x55 byte. A
slave device never responds to a packet that does not start with
0x55. Single byte packets are allowed due to the required start code.</P>
<H3 CLASS="western">Meanings of packet fields:</H3>
<H4 CLASS="western">Preamble</H4>
<P CLASS="western">This is simple a fixed 0x55 used to indicate a
packet start.</P>
<H4 CLASS="western">Packet-Type</H4>
<P CLASS="western">An index into a list of standard packet-types that
is listed in the tables.<BR>A node receiving a packet with a type
that it does not understand should ignore it.</P>
<H4 CLASS="western">Address</H4>
<P CLASS="western">A 16 bit destination address. The first 4096
addresses are reserved however any other address may be assigned to a
device or used as a group address. Address 1 is reserved for the
master and address 0 is reserved for ALL slaves.</P>
<H4 CLASS="western">Length</H4>
<P CLASS="western">The length field is to include the Packet-Type,
Address, Length, and CRC but not the preamble.</P>
<P CLASS="western">Therefore the length byte of an empty message will
be 6, allowing for 249 bytes of data.</P>
<P CLASS="western">The overhead of a maximal length packet is only
2%, however the overhead of a Parameter read request for short data
such as a single float32 is around 4.5 times the length of the data
due to the request packet and the overhead involved with the
response.</P>
<H4 CLASS="western">Data Payload</H4>
<P CLASS="western">Meaning is specific to the packet-type.</P>
<H4 CLASS="western">CRC</H4>
<P CLASS="western">A cyclic redundancy check used to detect errors. A
slave should completely ignore packets with known errors in them. It
is the responsibility of the master to retry if necessary. The CRC is
the has of the entire rest of the packet EXCLUDING the preamble. The
polynomial is to be 0x1C86C, not reversed, with 0 as the initial
value and no final XOR. The CRC is to be transmitted high byte first,
unlike the rest of Gazebo's data, to comply with the traditional CRC
ordering.</P>
<H3 CLASS="western">Short Packets</H3>
<P CLASS="western">Short Packets are used to avoid the overhead of a
full packet. A short packet consists of one or more bytes that do not
include 0x55.</P>
<P CLASS="western">The major uses of short packets are Slave Presence
Responses, which consist of the 0x00 byte, And ACK packets, which
consist of the ASCII ACK byte. 
</P>
<P CLASS="western">Short packets can also represent binary or
hexadecimal simply by transferring the actual ASCII character such as
'1' or '0' or 'F'</P>
<H2 CLASS="western">Timing and Delimiting rules</H2>
<H3 CLASS="western">Acknowledgment and Responses</H3>
<P CLASS="western">Some packets-type specify that the slave must give
a response. 
</P>
<P CLASS="western">This response must be given within 5 byte times or
10% of the time it took to send the message, however slaves <STRONG>should
</STRONG>respond within one byte time for maximum throughput . The
same rules apply for data responses to parameter requests and the
like. 
</P>
<P CLASS="western">The execption to this rule is Nonvolatile Memory.
When the master sends a command to write to NV memory it should be
prepared to wait up to 100ms+25ms per byte that needs to be written.
Devices of course should still carry out this operation as fast as
possible.</P>
<H3 CLASS="western">Delimiting</H3>
<P CLASS="western">The beginning of a packet is to be detected by an
[0x55](ASCII 'U') appearing when the receiver is idle. 0x55 is chosen
because it is common to do auto baud-detection, and also because no
byte at a baud rate slower than you receive on can erroneously appear
as an 0x55.</P>
<P CLASS="western">Receivers are to go idle after a full packet has
been received, OR after the greater of 10ms or 1 byte-time at the
current speed have passed without data. This feature means that
multiple baud rates can coexist on one bus without the use of
auto-baud detection. 
</P>
<P CLASS="western">The master has only to wait more than 1 byte times
at the new rate or 10ms before sending data after changing baud
rates. No inter-frame spacing is required between frames of the same
baud rate, because slaves detect end of packet based on length.</P>
<P CLASS="western">The master <STRONG>should </STRONG>check to make
sure no noise has been on the bus in the last 1 byte-time or 10ms
before transmitting for maximum reliability and throughput.</P>
<P CLASS="western">When any error is detected, the master <STRONG>should
</STRONG>wait at least 2 byte-times or 25ms before transmitting
again.</P>
<P CLASS="western">No packet may include more that 1 byte-time in
between bytes, nor may more than 15% of the total content of any
packet be blank space between bytes. 
</P>
<H3 CLASS="western">Initiation</H3>
<P CLASS="western">All communication is to be initiated by the
master. <BR>Packets going <STRONG>TO</STRONG> the master must have <STRONG>1</STRONG>
as the LSB of the packet type.<BR>Packets going <STRONG>FROM</STRONG>
the master must be <STRONG>0</STRONG> as the LSB. <BR>This lets a
slave decide to handle a packet or not within two bytes.</P>
<H2 CLASS="western">Slave Properties</H2>
<P CLASS="western">Every slave is to have a fixed 16 byte random
identifier that is only used until the master assigns the slave a 2
byte Network ID. The random identifier may be programmed at the
factory or generated and saved at first power-up. The 2 byte network
ID is to be initialized to 0 after a reset. The master can then use
the UUIDS to run a binary search and assign devices specific
temporary network IDs.</P>
<H2 CLASS="western">Addressing</H2>
<P CLASS="western">Addresses are simple 16 bit numbers with no
semantics whatsoever except for the reserved address range 0-4096.
Address 0 is the broadcast address, address 1 is the master, all
other addresses can be freely assigned.</P>
<P CLASS="western">Any slave must respond on its own address, the
broadcast address, and any of its four group addresses exactly
uniformly. A slave should respond to a broadcast packet exactly as it
would a packet addressed only to it. Slaves must default to address 0
at power-up.</P>
<P CLASS="western">Addresses 256 through 512 are reserved for Small
Gazebo, the restricted subset of Gazebo.</P>
<H2 CLASS="western">Supported Baud Rates</H2>
<P CLASS="western">All devices by default must boot up to a rate of
4800 baud. All devices must support at least 9800 baud. Higher baud
rates may be selected by broadcast or on a per-device basis. Baud
rates are changed via a command that represents the rate as a uint8
interpreted as an index into the following table:</P>
<P CLASS="western">The baud rate table for all devices is:<BR>Index =
Rate<BR>0 = 100<BR>1 = 300<BR>2 = 1200<BR>3 = 2400<BR>4 = 4800<BR>5 =
9600<BR>6 = 38400<BR>7 = 57600<BR>8 = 115,200<BR>9 = 250,000<BR>10 =
500,000<BR>11 = 1,000,000</P>
<P CLASS="western">The choice of baud rates was designed to allow
easy operation from modern crystals which are often (2^n)*(1000^m)
hertz. The inclusion of &quot;traditional&quot; baud rates is only
for compatibility with legacy hardware and serial ports. Baud rates
below 115.2k use only traditional values because the error introduced
from the combination of a modern crystal and a low &quot;traditional&quot;
rate is likely to be low due to the high divider value used relative
to any rounding error.</P>
<H2 CLASS="western">Valid Packet Types</H2>
<P CLASS="western">In this section the packet types are listed by
type code and sorted into two categories: Packets sent only by the
master and packets sent only by the slave. Packets sent by the master
have even packet type codes and packets sent by the slave have odd
packet type codes.</P>
<P CLASS="western">Headings are preceded by their Packet Type codes,
specified in decimal.</P>
<H3 CLASS="western">Master May Send These</H3>
<H4 CLASS="western">0: Slave Presence Detect Request</H4>
<P CLASS="western">(Required for all slaves to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[16 bytes UUID] [2 Bytes network address] [16
Bytes UUID bitmask] [2 Bytes Network Address bit mask]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Slaves are required to respond with a slave
presence declaration packet if the bit pattern matches theirs. A zero
in any bit mask bit designates a &quot;Don't Care' bit allowing for
binary search trees over all nodes or only those nodes that have not
been assigned network IDs yet, avoiding use of recursion or excessive
ram in the enumeration routine.</P>
<P CLASS="western">By requesting only nodes that have not been
assigned a network address(by setting 0 as the required address) You
always get a new slave each time you run the search tree and can loop
through slaves easily without using recursion of other complex
algorithms(at least complex by embedded standards)</P>
<H4 CLASS="western">2:Slave Address Set Command</H4>
<P CLASS="western">(Required for all slaves to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[16 bytes UUID] [2 Bytes New network address]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Instructs the slave with a UUID that matches the
UUID in the packet to set its temporary network address to the 2 byte
address sent. The slave must respond with a slave ACK packet.</P>
<H4 CLASS="western">4:Slave Information Request</H4>
<P CLASS="western">(Required for all slaves to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[1 byte page number]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Slaves must return a string of data up to 248
bytes long with starting position is S=(248*Page Number) of the Slave
Description String.<BR>The slave description string must be null
terminated and the last page should not contain data after the
null.<BR>The format is UTF-8. For example:<BR>Page 1 would by bytes
0-247<BR>Page 2 would be bytes 248-496<BR>etc. until the last page
which may be less than 248 bytes long and must have a null terminator
as the last byte.</P>
<H4 CLASS="western">6:Parameter Information Request</H4>
<P CLASS="western">(Required for all slaves to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[1 byte parameter number]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Slave must respond with a Data Response containing
a null-terminated string satisfying a format or with the appropriate
error if the parameter number is out of range.</P>
<H4 CLASS="western">8:Parameter Value Read</H4>
<P CLASS="western">(Required for all <STRONG>relevant</STRONG> slaves
to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[1 byte parameter number] [optional 1-239 byte
arguments]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Slave must respond with the current value of the
requested parameter or with the appropriate error if the Parameter
Number is out of range, or the wrong amount of argument data was
passed.<BR>The return value must be encapsulated as a slave data
response, or as a short packet.<BR>If the parameter is a function,
the appropriate arguments must be passed. All arguments should be
concatenated in the order they appear in the arguments list in the
Parameter Descriptor.</P>
<H4 CLASS="western">10: Parameter Write</H4>
<P CLASS="western">(Required for all <STRONG>relevant</STRONG> slaves
to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[1 Byte parameter number] [1-239 bytes Data]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Command to write Data to the selected
Parameter.<BR>Slave must respond with a Slave Acknowledge message, or
with the appropriate error if the Parameter Number is out of range,
the Data to be written is the wrong length or otherwise incorrect, or
if any other error occurs..</P>
<P CLASS="western"><BR><BR>
</P>
<H4 CLASS="western">12: Parameter Write Without Acknowledge</H4>
<P CLASS="western">(Required for all <STRONG>relevant</STRONG> slaves
to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[1 Byte parameter number] [1-239 bytes Data]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Command to write Data to the selected Parameter
without requesting an acknowledgment.<BR>Slaves must NOT respond with
acknowledgment. In case of errors slaves must still remain silent.</P>
<H4 CLASS="western">14: Baud Rate Set Command</H4>
<P CLASS="western">(Required for all slaves to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[1 byte index into the baud rate table in
<EM>Supported Baud Rates</EM>]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Slaves must set their transmit and receive baud
rates to this value. Slaves must respond with an ACK packet or with
the appropriate error is the baud rate is out of range or any other
error occurs. The ACK packet should be sent at the current baud rate,
not the new one.</P>
<H4 CLASS="western">16: Information Broadcast Message:</H4>
<P CLASS="western">(Slaves may ignore this message)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[8 bytes broadcast identifier] [0-232 Bytes
Payload Data]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">A standard way for the master to broadcast short
pieces of information, such as the current time, data about the
master, cryptographic nonces, or other information that a large
number of nodes would be interested in. 
</P>
<P CLASS="western">Information that is global to the network such as
the current time should only be sent using an Information Broadcast
Message. Slaves must never respond to an information broadcast
message.</P>
<P CLASS="western">Even though this is called a &quot;Broadcast&quot;,
slaves must ignore Information Broadcast Messages not addressed to
them, a group they are a member of, or the global broadcast address.
This is to ensure that it is possible to broadcast information to
only a subset of slaves.</P>
<P CLASS="western">Non-standard information broadcast keys(those not
defined in this standard in <EM>Standard Information Broadcast Keys</EM>)
must not use all capital names.</P>
<H4 CLASS="western">18: Group Join Command</H4>
<P CLASS="western">(Required for all slaves to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[2 bytes new group address]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Command a slave to ALSO listen on a group
address<BR>Slaves must respond with a Slave Acknowledge message.<BR>If
the slave is already a member of that group, return the same
acknowledge message.<BR>If there is no more space to store group
addresses, return an error.</P>
<H4 CLASS="western">20: Group Quit Message</H4>
<P CLASS="western">(Required for all slaves to handle)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[2 bytes group to quit message]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Commands a device to quit the specified group. If
the specified group is 0, quit all groups.<BR>Slave must respond with
a Slave Acknowledge message.<BR>If the slave is not a member of that
group, return the acknowledge anyway.</P>
<H4 CLASS="western">22: Save Parameters to Nonvolatile Memory</H4>
<P CLASS="western">(Only slaves with nonvolatile parameters must
implement this)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[7 bytes comprising the word CONFIRM in uppercase
ASCII]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">This will cause the slave to save all parameters
that are marked with the 'n' flag to permanent storage.<BR>The
current value will become the new default at power up. Slaves must
respond with acknowledgment or the appropriate error.</P>
<P CLASS="western">This allows for a standardized way to implement
configurable devices such as electronic speed controllers and motion
detector sensitivity thresholds. Master software should require
confirmation such as &quot;Are you sure you want to make the current
settings the new default?&quot; before continuing.</P>
<P CLASS="western">As mentioned in <EM>Timing and Delimiting rules</EM>,
when the master sends a command to write to NV memory it should be
prepared to wait up to 100ms+25ms per byte that needs to be written.</P>
<H4 CLASS="western">111-127: Device Specific Commands</H4>
<P CLASS="western">This range of packet types has been reserved for
device specific messages.<BR>Messages going to the master should
still be odd and messages from the master should still be even.</P>
<H3 CLASS="western">Slave may send these</H3>
<H4 CLASS="western">1: Slave Presence Declaration</H4>
<P CLASS="western">(short packet)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">The entire packet is just 1 0x00 byte set in
response to a presence detect.</P>
<H4 CLASS="western">3: Slave Acknowledge Message</H4>
<P CLASS="western">(short packet)</P>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[the entire packet is 1 ASCII ACK]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Sent in response to any successful command that
requires acknowledgment</P>
<H4 CLASS="western">5: Slave Error Message</H4>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[1 byte index into error table] [0-239 bytes UTF-8
Description]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">A generic error response that may contain an
extended plaintext description.</P>
<H4 CLASS="western">7: Slave Data Response</H4>
<H5 CLASS="western">Payload</H5>
<P CLASS="western">[0-240 Bytes of data to be interpreted by the
master based on context]</P>
<H5 CLASS="western">Description</H5>
<P CLASS="western">Sent in response to any request for data by the
master at all, Except in cases of error.</P>
<H4 CLASS="western">111-127: Device Specific Commands</H4>
<P CLASS="western">This range of packet types has been reserved for
device specific messages.<BR>Messages going to the master should
still be odd and messages from the master should still be even.</P>
<H2 CLASS="western">Error Codes</H2>
<P CLASS="western">The valid error codes are:</P>
<H3 CLASS="western">0: Error</H3>
<P CLASS="western">Generic Error Occurred. A device may send error 0
instead of any other error if there is not enough flash to properly
implement specific errors. If used to indicate a Application Level
error, there should be extra information attatched.</P>
<H3 CLASS="western">1: Nonexistent Parameter</H3>
<P CLASS="western">A read or write was attempted to something not
there.<BR>i.e. the parameter index was higher than that of the last
parameter.</P>
<H3 CLASS="western">2: Bad Input</H3>
<P CLASS="western">Invalid data was sent.<BR>e.g. Attempting to write
an invalid value to a byte array that must conform to a specific
interpretation.</P>
<H3 CLASS="western">3: Insufficient Power</H3>
<P CLASS="western">The requested operation would exceed available
electrical power.<BR>e.g. Attempting to trigger a solenoid coil when
only the limited power from the network bus is available.</P>
<H3 CLASS="western">4: Not Available in this Mode</H3>
<P CLASS="western">The slave is not currently configured for the
requested operations.<BR>e.g. Attempting to read an ADC value when
the ADC is disabled.</P>
<H3 CLASS="western">5: Unsupported Action</H3>
<P CLASS="western">The parameter selected does not support this
action.<BR>e.g. attempting to read from a write-only parameter or
vice versa.</P>
<H3 CLASS="western">6: Critical Internal Error</H3>
<P CLASS="western">The slave has encountered an error, such as a
watchdog interrupt, and is currently offline.</P>
<H3 CLASS="western">7: Too much data sent in write request</H3>
<P CLASS="western">The write request tried to write more data than
fits in the selected variable.</P>
<H3 CLASS="western">8: Too short data sent in write request</H3>
<P CLASS="western">The write request tried to write less data than
would fit in the selected variable.</P>
<H3 CLASS="western">9:Too Many Groups</H3>
<P CLASS="western">There was a request to join a group but there is
no more space to store group addresses. Quit at least one group and
retry.</P>
<H3 CLASS="western">10: Expected Less Data in Read Request</H3>
<P CLASS="western">You made a read request with a longer string of
arguments than expected. Can also indicate that 0 bytes of arguments
were expected.</P>
<H3 CLASS="western">11: Expected More Data in Read Request</H3>
<P CLASS="western">You made a read request to a parameter that takes
arguments but did not pass enough data.</P>
<H2 CLASS="western">Slave Description String</H2>
<P CLASS="western">This is the string that describes a slave and may
be up to (248*256)-1 bytes long.<BR>It must be of the form:<BR>(Without
enclosing Square Brackets or line breaks)</P>
<P CLASS="western">[Gazebo Major Version, Product Name, Device
Firmware Version, flags, Number of parameters,maximum baud
rate,description,key-value object]</P>
<P CLASS="western">Any field may be empty except number of parameters
and maximum baud rate.<BR>Numbers must be decimal numbers without
thousands separators.</P>
<P CLASS="western">The meanings of the fields are as follows.</P>
<H3 CLASS="western">Gazebo Major Version</H3>
<P CLASS="western">The major part of the version. If the devices was
built to comply with a non integer(experimental version), the full
number should be prefixed by an x.</P>
<H3 CLASS="western">Product Name</H3>
<P CLASS="western">The product name identifies the type of device.
The individual device name allows that specific device to be given a
name.</P>
<H3 CLASS="western">Device Firmware Version</H3>
<P CLASS="western">An arbitrary short string which is specific to the
device.</P>
<H3 CLASS="western">Flags</H3>
<P CLASS="western">A lit of single character flags. This field
reserved for future use as no flags are currently defined.</P>
<H3 CLASS="western">Number of parameters</H3>
<P CLASS="western">What it says on the tin, in decimal of course.</P>
<H3 CLASS="western">Maximum Baud Rate</H3>
<P CLASS="western">A decimal or hexadecimal prefaced with 0x number
in units of baud. ignored for USB only devices.</P>
<H3 CLASS="western">Description</H3>
<P CLASS="western">An arbitrary mUTF-8 description.</P>
<H3 CLASS="western">Key-Value object</H3>
<P CLASS="western">The key-value object is a simple JSON object that
may contain the following:</P>
<H4 CLASS="western">Listeners:</H4>
<P CLASS="western">An associative array(Object in JSON terminology)
of Listener Description Strings(Having an identical format to a
Parameter Description String) indexed by the Broadcast Key being
listened to.</P>
<P CLASS="western">This lets the master know what broadcast keys it
will listen to, and the Listener Description String allow the master
to know what format the data is expected in, and what its meaning is.</P>
<H4 CLASS="western">SListeners</H4>
<P CLASS="western">A list of strings, each one being the name of a
standard information broadcast key(as listed in <EM>Standard
Information Broadcast Identifiers</EM>) that the device implements.</P>
<H2 CLASS="western">Parameter Description String</H2>
<P CLASS="western">The parameter description string is a CSV string
enclosed by square brackets of the following form:</P>
<P CLASS="western">(Without Enclosing Square Brackets)<BR>[Parameter
Name, Return Type,Interpretation,[
[Name;Type;Interpretation];...],flags,group role,group name,group
class,description,key-value object]</P>
<P CLASS="western">Whitespace will be interpreted literally.</P>
<H3 CLASS="western">Parameter Name</H3>
<P CLASS="western">The name of the parameter. May only contain a-z
A-Z and the underscore. Two parameters may not share a name. Names
are case sensitive but names differing only in case should not be
used to avoid confusion.</P>
<H3 CLASS="western">Type</H3>
<P CLASS="western">Equivalent to concepts of type in programming
languages, this field fully specifies the range of lengths the
parameter may take on. The type is expressed as a string, optionally
followed by either [len] or [lenmin:lenmax] to denote an array.
Multidimensional arrays are allowed and considered arrays of arrays.</P>
<H3 CLASS="western">Interpretation</H3>
<P CLASS="western">Interpretation is used to give meaning to the
data, and could be as simple as &quot;milliKelvin&quot;.<BR>Interpretation
should only be used for the units and not for specifics such as
&quot;front room temp&quot; which is better suited to the name. 
</P>
<P CLASS="western">Interpretation should be thought of as a
&quot;subtype&quot;. Good examples are &quot;Score&quot;, &quot;Volts&quot;,
&quot;meters/second&quot;, or &quot;micrometers&quot;. Bad examples
are &quot;FirstSwitch&quot;, &quot;LivingRoomLightLevel&quot; or
anything else device or application specific. See Naming of
Interpretations for more details.</P>
<P CLASS="western">When naming interpretations for custom formats,
you can prefix them with a base64 UUID as described before, or you
can simply place the variable inside a group representing your
interface.</P>
<P CLASS="western">Should the parameter be a tuple, each element of
the tuple should be given its own interpretation and interpretations
should be separated by semicolons. example, a (float32;float32) tuple
with interpretation (Kelvin;Relative Humidity)</P>
<H3 CLASS="western">[ [Name,Type,Interpretation]...]</H3>
<P CLASS="western">This entire field may be blank. If it is not, than
it is a list of parameters that must be passed when &quot;calling&quot;
i.e. reading from the parameter. Bracketed 3-tuples of name,type, and
interpretation.<BR>Only the last parameter may be a variable array.</P>
<H3 CLASS="western">Flags</H3>
<P CLASS="western">This field is a set of one character flags
describing the parameter's properties. The list of valid flags is
described in <EM>Valid Flags</EM>.</P>
<H3 CLASS="western">Group Role</H3>
<P CLASS="western">This describes the <EM>Role </EM>that an
individual parameter plays in a group. An example would be <CODE CLASS="western">Derivative
</CODE>for a variable to control the derivative gain in a group
representing a PID control loop. May be blank for ungrouped
parameters. A group may not have multiple variables playing the same
role.</P>
<H3 CLASS="western">Group Name</H3>
<P CLASS="western">This is the name of the group, if any, that the
variable is a part of. A group is analogous to an object instance. A
device may not have two groups with the same name. May be blank for
ungrouped parameters.</P>
<H3 CLASS="western">Group Class</H3>
<P CLASS="western">The class of group that the parameter is in. All
parameters with the same group name must have the same group class.
Anyone can define a group class, so to avoid conflict between
unrelated manufactures the company or individual name may be
prepended to the group name, or alternately a UUID in base64 may be
prepended. May be blank for ungrouped parameters.<BR>Group classes
beginning with an asterisk &quot;*&quot; are reserved for &quot;official&quot;
standard group classes.</P>
<H3 CLASS="western">Description</H3>
<P CLASS="western">A plain text description, in quotes, with all
quotes escaped by a backslash and newlines converted to \n. May be
UTF-8 and may be formatted as reStructuredText.</P>
<H3 CLASS="western">Key-Value Object</H3>
<P CLASS="western">A JSON file with additional attributes may be
placed here. May be blank. All additional attribute names beginning
with an asterisk &quot;*&quot; are reserved for &quot;official&quot;
attributes. Official Additional Attributes may be found in <CODE CLASS="western">Additional
Attributes</CODE>.</P>
<H3 CLASS="western">Valid Flags</H3>
<P CLASS="western">Flags may appear in any order and are case
sensitive.</P>
<H4 CLASS="western">0-9= Group Class Specific</H4>
<P CLASS="western">A group class can define special meaning for
numerals appearing in its members' parameters' metadata. You will
find these meanings in the Interface Documentation provided by the
party that specified the interface.</P>
<H4 CLASS="western">r=readable</H4>
<P CLASS="western">The parameter may be read by Master</P>
<H4 CLASS="western">w=writable</H4>
<P CLASS="western">The master may write here</P>
<H4 CLASS="western">i=reads are idempotent</H4>
<P CLASS="western">Any number of consecutive reads will return the
same data unless something external changes it. However the act of
reading itself may not cause changes. For parameters that take
argumets to thier read operations, idempotency only applies where two
reads have the same arguments.</P>
<H4 CLASS="western">I=writes are idempotent</H4>
<P CLASS="western">N+1 writes of the same data have the same effect
as N writes. Does not imply that write A followed by write B where A
and B have different data is equivalent to write B alone.</P>
<H4 CLASS="western">b=this is an interface to a item-wise FIFO buffer</H4>
<P CLASS="western">The type of the parameter must be an variable
array, with size 0 to N. Reading from this an array containing the
oldest N items from a queue. If the item is variable sized, N will
always be 1.</P>
<P CLASS="western">Arrays of arrays are allowed, with each inner
array in the outermost array being considered one item. Data items
written here are entered into the queue. The same rules apply.</P>
<P CLASS="western">Older items will always be first in the returned
array. If the queue is empty a message with no payload will be
returned.</P>
<P CLASS="western"><EM>Buffered types should not be both readable and
writable.</EM></P>
<H4 CLASS="western">B=message-wise FIFO buffer</H4>
<P CLASS="western">This is an interface to a FIFO buffer, reads will
always return the oldest 1 element. The type may be a variable array
but operations should still be considered as returning 1 &quot;message&quot;
of variable length, unlike an item-wise buffer, which returns the top
N items of fixed size. The same rules apply for writing. If the queue
is empty an empty packet will be returned. 
</P>
<P CLASS="western"><EM>Buffered types should not be both readable and
writable.</EM></P>
<H4 CLASS="western">s=side effects to reading here</H4>
<P CLASS="western">Indicates that reading the parameter will have an
effect such as popping the last item in a queue.</P>
<H4 CLASS="western">f=function return</H4>
<P CLASS="western">Indicates that the parameter should be considered
a return value for parameters passed into other parameters of the
group. A read will trigger execution of the function</P>
<H4 CLASS="western">n=nonvolatile</H4>
<P CLASS="western">Anything written here will be saved to nonvolatile
memory when the Save Parameters to Nonvolatile Memory command is
issued. It should be considered acceptable for the device to take
more time than normal to read or write these. 
</P>
<P CLASS="western">A slave must not commit this parameter to
nonvolatile memory under any circumstances unless the Save Parameters
to Nonvolatile Memory command is issued, to allow frequent updates
without fear of undue wear on the storage devices. 
</P>
<P CLASS="western">Slaves should support at least ten thousand erase
cycles.</P>
<H4 CLASS="western">m=mirror</H4>
<P CLASS="western">This register has functionality overlapping one or
more other registers. For example, an ADC that has data available as
a float or as an int.</P>
<H4 CLASS="western">c=command</H4>
<P CLASS="western">A write to this should be considered an explicit
command rather than data storage or setting I/O, and the
Interpretation should give a name for the command type.</P>
<H4 CLASS="western">!= Important</H4>
<P CLASS="western">The voltage control of a lab power supply would be
one example. This flag indicates that extreme care must be used when
writing and possibly even when reading. Bootloaders, LED current
limiters, things that could cause damage to the node or damage to
connected equipment all fall under this category.</P>
<P CLASS="western">Master side software may choose to require extra
confirmation before changing these parameters. A standard message
might be:</P>
<P CLASS="western"><CODE CLASS="western">&quot;This parameter has
been marked as Important. An incorrect value in this parameter may
cause hardware damage. Are you sure you want to continue?&quot;</CODE></P>
<H2 CLASS="western">Data Types</H2>
<P CLASS="western">The standard data data types are:</P>
<H3 CLASS="western">Basic Types</H3>
<P CLASS="western">As previously mentioned, all data is
little-endian.</P>
<H4 CLASS="western">float32</H4>
<P CLASS="western">IEEE Single Precision floating point value.</P>
<H4 CLASS="western">uint8</H4>
<P CLASS="western">Unsigned 8 bit integer.</P>
<H4 CLASS="western">uint16</H4>
<P CLASS="western">Signed 16 bit integer.</P>
<H4 CLASS="western">uint32</H4>
<P CLASS="western">Unsigned 32 bit integer.</P>
<H4 CLASS="western">int8</H4>
<P CLASS="western">Signed 8 bit integer.</P>
<H4 CLASS="western">int16</H4>
<P CLASS="western">Signed 16 bit integer.</P>
<H4 CLASS="western">int32</H4>
<P CLASS="western">Unsigned 32 bit integer.</P>
<H4 CLASS="western">enum{FirstPossibleValue|SecondPossibleValue|etc}</H4>
<P CLASS="western">An enumeration similar to C enumerations. Between
the brackets can be any number for 0 to 255 of pipe separated
identifiers which may not contain spaces or commas or brackets. This
should be considered exactly the same as a uint8 with additional
semantics attached. Keep in mind parameter description strings are
limited to 248 bytes total.</P>
<H4 CLASS="western">UTF-8</H4>
<P CLASS="western">Alias of <CODE CLASS="western">uint8</CODE>, used
to indicate that this should be interpreted as a string. Null
terminators should not be sent.</P>
<H3 CLASS="western">Composite Types</H3>
<H4 CLASS="western">Arrays</H4>
<P CLASS="western"><STRONG>An array type of any Base Type is valid</STRONG>,
following the convention type[count] or type[min:max] for variable
lengths.</P>
<P CLASS="western">An example would be a byte[10] array. Every write
must write every index and every read will return the entire array. 
</P>
<P CLASS="western">A write to a float[0:50] array may contain 0 to 50
floats, and a read to a float[0:50] array will return 0 to 50 results
depending on how many items are stored there currently. 
</P>
<P CLASS="western">Multidimensional arrays are considered arrays of
arrays, and only the last element may be variable. the syntax for a
multidimensional array is basetype[a][b], representing b arrays of
size a. any number of dimensions is allowed. uint8[10][0:10] would be
valid whereas uint8[1:5][10] would not. 
</P>
<P CLASS="western">The actual transmission format for a
multidimensional array is to send each element of the first array,
then each element of the second array, and so on. We essentially
treat the array as a basetype and send an array of it, which may
further be considered yet another type of array and repeated. For an
example of array serialization:[ [ 1,2] , [3,4] ]would serialize to
[1,2,3,4].</P>
<H4 CLASS="western">Tuples:</H4>
<P CLASS="western">A tuple may contain any basic type or array. Tuple
elements are separated by semicolons and may not be other tuples.
Tuples are serialized by concatenation in the same way as read
arguments. Just like arguments, only the last element in a tuple may
be of variable size. Tuples do not have any special enclosing syntax
and are simple semicolon separated lists.<BR>An example of a valid
tuple: &quot;uint8;uint8;float32;UTF-8[0:32]&quot;</P>
<P CLASS="western">Each field of the tuple should be given its own
name via the *tuple attribute in <EM>Additional Attributes</EM>.<BR>Gazebo
does not support 1-tuples.</P>
<H3 CLASS="western">Special Types</H3>
<P CLASS="western">These may return 1-Byte Short Packets.</P>
<H4 CLASS="western">Bool</H4>
<P CLASS="western">When read from, returns a 1-byte packet consisting
of ASCII 0 or 1.<BR>Writes as a uint8 with literal 1 or 0 not ASCII 1
or 0 values.</P>
<H4 CLASS="western">Hex</H4>
<P CLASS="western">When read from, returns a hex digit represented as
1 ASCII byte<BR>Writes as a uint8 from 0 to 15.</P>
<H4 CLASS="western">void</H4>
<P CLASS="western">No data whatsoever. Used for read with
arguments(function calls) used purely for side effects.<BR>The short
packet 0x06(Acknowledgement) should be sent in response to a
successful read from void parameter.</P>
<H2 CLASS="western">Standard Information Broadcast Identifiers</H2>
<H3 CLASS="western">TIME</H3>
<P CLASS="western">The current time in 64 bit format</P>
<H3 CLASS="western">MASTER</H3>
<P CLASS="western">The friendly name of the current master</P>
<H3 CLASS="western">LOCATION</H3>
<P CLASS="western">The current location, in space separated hierarchy
format,</P>
<H3 CLASS="western">GPS</H3>
<P CLASS="western">A GPS report in some better format than NMEA</P>
<H3 CLASS="western">MILLIS</H3>
<P CLASS="western">The milliseconds part of the current time as 16
bit unsigned</P>
<H3 CLASS="western">SECONDS</H3>
<P CLASS="western">The seconds part of the current time as 8 bit
unsigned</P>
<H3 CLASS="western">MINUTES</H3>
<P CLASS="western">The minutes part of the current time as 8 bit
unsigned</P>
<H3 CLASS="western">HOURS</H3>
<P CLASS="western">The hours part of the current local time as 8 bit
unsigned</P>
<H3 CLASS="western">DAY</H3>
<P CLASS="western">The local day of the year as 16 bit unsigned.</P>
<H3 CLASS="western">MONTH</H3>
<P CLASS="western">The current local month as 8 bit unsigned</P>
<H3 CLASS="western">YEAR</H3>
<P CLASS="western">The current local Year as 32 bit unsigned</P>
<H3 CLASS="western">DAYINFO</H3>
<P CLASS="western">A UTF-8 Null-Terminated string of information
related to the current day, such as 'President's Day'.</P>
<H3 CLASS="western">TIMEZONE</H3>
<P CLASS="western">The local timezone as 8 bit unsigned</P>
<H3 CLASS="western">DAYoWEEK</H3>
<P CLASS="western">The current day of the week as 8 bit unsigned.</P>
<H3 CLASS="western">RANDOM</H3>
<P CLASS="western">An arbitrary amount of random data transmitted by
the master. This is not intended as an exclusive source of entropy
but is rather intended to be combined with some fixed or variable
entropy present on the slave. The intent is to allow a simpler hash
or combining function than would be needed to use the time as a
random seed. You should NOT use this as a seed for generating the
UUIDs on first power up because of the possibility of two devices
needing a UUID at once.</P>
<H3 CLASS="western">mKELVIN</H3>
<P CLASS="western">The temperature as sensed by the master in
milliKelvin as 32 bit unsigned</P>
<H3 CLASS="western">VOLTAGE1</H3>
<P CLASS="western">The voltage as sensed by the master which is
likely also the power supply in milliVolts as 16 bit unsigned.</P>
<H3 CLASS="western">LANGUAGE</H3>
<P CLASS="western">A comma separated list of preferred languages
specified as ISO 639-2 codes from most to least preferred.</P>
<H3 CLASS="western">DEVICES</H3>
<P CLASS="western">A uint16 expressing the total number of devices
that the master knows to be present on the bus</P>
<H3 CLASS="western">SupplymA</H3>
<P CLASS="western">A uint16 expressing the total load on the master's
power supply.</P>
<H2 CLASS="western">Additional Attributes</H2>
<P CLASS="western">These may be applied to expose more information
about the parameter.</P>
<H3 CLASS="western">*qlen</H3>
<P CLASS="western">Applied to a queue indicates length in bytes</P>
<H3 CLASS="western">*maxpoll</H3>
<P CLASS="western">A string that indicates the maximum polling rate
that will result in meaningful data as opposed to repeats of old
data. The string must be a rate format string as described in <CODE CLASS="western">Rate
Format Strings</CODE></P>
<H3 CLASS="western">*max</H3>
<P CLASS="western">A number indicating the maximum value that a
numeric parameter may be set to</P>
<H3 CLASS="western">*min</H3>
<P CLASS="western">A number indicating the minimum value a numeric
parameter may be set to.</P>
<H3 CLASS="western">*fields</H3>
<P CLASS="western">A string containing a comma separated list of
names, one for each field in the tuple.<BR>example
&quot;*fields&quot;=&quot;temperature;humidity&quot;</P>
<H2 CLASS="western">Rate Format Strings</H2>
<P CLASS="western">A rate format string is a number followed by one
of <CODE CLASS="western">us,ms,s,m,h,Hz,KHz, or MHz.</CODE><BR>It
simply indicates a maximum repetition rate in a flexible way.</P>
<H2 CLASS="western">Naming of Interpretations</H2>
<P CLASS="western">To increase compatibility and decrease conflict,
the following rules should be used when naming Interpretations</P>
<P CLASS="western"><STRONG>Reference should be made to the SI
brochure.</STRONG> Units with official SI symbols should be
abbreviated unless the official SI symbol is a character that ASCII
does not encode in which case they should be spelled out in full.</P>
<P CLASS="western">Non-SI units should never be abbreviated except as
listed below. SI capitalization rules should be followed. 
</P>
<P CLASS="western"><STRONG>In addition to the SI units,</STRONG> the
liter may be used with abbreviation L and the degree may be used with
abbreviation deg, Any other unit used should be spelled in full.</P>
<P CLASS="western">SI prefixes that are not powers of 1000(H,h,D,d)
should be avoided. SI prefixes should <EM>never</EM> be used to refer
to the powers of two(e.g. Kilo used to mean 1024), Instead the binary
prefixes(Ki,Mi,Gi,Ti,etc) should be used.</P>
<P CLASS="western">Various non-metric customary units such as ounces,
pounds, and feet should be avoided when possible.</P>
<P CLASS="western">Compound units should always be created with the
forward slash for division and caret to denote exponentiation e.g.
<CODE CLASS="western">m/s^2</CODE> or <CODE CLASS="western">kg/m^3</CODE>.
</P>
<P CLASS="western">Interpretation may also be used to define custom
types. The name &quot;unit&quot; was purposefully avoided to allow
complex named data structures. An example of this would be &quot;WaveForm&quot;
for a DDS function generator, or &quot;8/16kAudioStream&quot; for a
buffered 8 bit audio stream. 
</P>
<P CLASS="western">To avoid conflict, A UUID or a well-known company
name should be prepended to custom units.</P>
<P CLASS="western">Names beginning with any punctuation mark are
reserved for &quot;official&quot; and standardized Interpretations.</P>
<P CLASS="western">The unit &quot;counts&quot; should be used to
count events. 
</P>
<H3 CLASS="western">Examples</H3>
<P CLASS="western">&quot;kg&quot; Kilograms<BR>&quot;cm^3/s&quot;
Cubic centimeters per
second<BR>&quot;km/H&quot;<BR>&quot;EmptyDelimitedOGGFrame&quot;<BR>&quot;HexColor&quot;<BR>&quot;RGB&quot;<BR>&quot;RGB-A?&quot;(
RGB if 3 bytes, RGBA if four)</P>
<H2 CLASS="western">Reliability Concerns</H2>
<P CLASS="western">Gazebo was never designed to be used in life
safety, military, aerospace, medical, or similar applications.<BR>While
Gazebo was designed to be highly reliable, implementers must use the
protocol entirely at their own risk.</P>
<H3 CLASS="western">Multiple Baud Rates</H3>
<P CLASS="western">The use of multiple baud rates on the bus could
cause the device running at the lower baud rate to see an 0x55 when
none was sent. Should random line noise or higher bad rate
transmissions cause a device to see a valid packet type, preamble,
address, data length, and data, undefined operation may result. This
is unlikely to occur due to multiple layers of integrity checking,
however only a single baud rate should be used if reliability is
important.</P>
<P CLASS="western">This will not cause problems when commanding
devices individually to change to a higher baud rate if you do not
send any commands at the new higher baud rate until all devices have
changed to it, because it is not possible for any other data sent at
a lower baud rate to appear as an 0x55(which contains the maximum
number of transitions) at a higher rate if the higher rate is at
least twice the lower rate.</P>
<P CLASS="western">This will also not cause any problems commanding a
device to change to the next lower baud rate as long as you wait for
at least 3*the byte time of the slowest rate, or 10ms, whichever is
higher, as the baud rate set command is 8 bytes long, and 8 bytes
will appear as at most 4 bytes at any lower baud rate that is less
than half the rate. When the acknowledgememt arrives, it will appear
as at most 1 additional byte. Therefore the slave at the lower baud
rate will see at most 6 bytes, which is not enough for a valid long
packet, and therefore will be seen as 5</P>
<H3 CLASS="western">Acknowledgment</H3>
<P CLASS="western">The use of a one-byte acknowledgment sequence
creates the problem that random line noise could coincidentally
contain the ACK character and coincidentally appear within the
timeout just after the master sends a Write Request, causing the
master to think the command was successful even if it was not. Even
though the chances of this occurring are low, very important write
operations like bootloaders should use some form of readback
validation rather than depending on the built in acknowledgment
features.</P>
<H2 CLASS="western">Modbus Compatibility</H2>
<P CLASS="western">The use of modbus devices on the same bus is
possible if 0x00, 0x55, ASCII ACK, and ASCII zero through uppercase F
are not used as modbus addresses. However, modbus transmissions may
create similar situations described in <EM>Reliability
Concerns:Multiple Baud Rates.</EM></P>
<H2 CLASS="western">Labeling</H2>
<P CLASS="western">Ports that are intended to act as masters can be
labeled either with <CODE CLASS="western">MASTER</CODE> or <CODE CLASS="western">TO
SLAVES</CODE>.<BR>Ports intended as slaves can be labeled with <CODE CLASS="western">SLAVE</CODE>
or <CODE CLASS="western">TO MASTER</CODE><BR>Switches should be
labeled <CODE CLASS="western">MASTER|SLAVE</CODE> or <CODE CLASS="western">ACT
AS MASTER|ACT AS SLAVE</CODE><BR>Bidirectional ports can be unlabeled
or labeled <CODE CLASS="western">MASTER/SLAVE SWITCHABLE</CODE><BR>Any
port may be unlabeled where space or cost does not permit
labeling.<BR>Devices should be marked with their maximum power
consumption.</P>
<H2 CLASS="western">Naming Conventions</H2>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0in">Devices with
	physical I/O pins or connection should organize their pins into
	ports of 8. 
	</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0in">Every port should
	be assigned a letter as the common MCU convention. 
	</P>
	<LI><P CLASS="western">Nonexistent pins within a port are allowed to
	allow 1 to 1 mapping of MCU pins to logical ports. 
	</P>
</UL>
<H2 CLASS="western">Device Documentation Conventions</H2>
<H3 CLASS="western">Specifying Required Bandwidth</H3>
<P CLASS="western">To specify the amount of bandwidth required by the
feature, one should specify the number of actual bits transferred
after accounting for start and stop bits, and network overhead bytes.
One should also always specify at what polling rate the data is valid
for. For example, a light switch might say: 
</P>
<P CLASS="western"><STRONG>On/Off switch function:</STRONG><BR><STRONG>Bandwidth:
400 Baud@5Hz polling</STRONG></P>
<H3 CLASS="western">Identifying Devices</H3>
<P CLASS="western">When there is a need to present an identifier for
a device, Base64 with the padding characters removed should be used
rather than the traditional UUID notation.</P>
<H2 CLASS="western">Design Patterns and Solutions</H2>
<P CLASS="western">These are suggestions, and not requirements for
compliant devices.</P>
<H3 CLASS="western">Partial Arrays and Data Segmentation</H3>
<P CLASS="western">Use a Position parameter and a Data parameter.
When you read or write the Data, you actually get the 0:248 bytes
after the pointer position. For write-only arrays you can also use a
byte array where the first byte is the index. Or you can use a read
with arguments interface.</P>
<H3 CLASS="western">User Interfaces</H3>
<P CLASS="western">Avoid directly reading the state of momentary
switches. Instead, you can define a rolling count of button presses,
or you can define a buffer of bytes for a keyboard. When you read it
you get all keys pressed since you last read from it. For buttons
that require accurate timing you can use a buffer of timestamps
recording the milliseconds part of the current time at each press.
Synchronize all devices using Information Broadcast Messages. For
switches, knobs, toggles, and sliders, you should just directly read
their state.</P>
<H3 CLASS="western">Measurements that require time</H3>
<P CLASS="western">For measurements that require time and/or energy
to take, such as an ultrasonic distance reading, you can either take
the measurement continuously and return the latest when polled, or
have a separate begin measurement parameter.</P>
<H3 CLASS="western">Energy Saving</H3>
<P CLASS="western">Things that require energy should always be able
to be turned off in software.<BR>Attempting to read from a disabled
sensor should always return error 4 Not Available in This Mode.</P>
<H3 CLASS="western">General Purpose I/O modules</H3>
<P CLASS="western">Each &quot;Special Function&quot; should have it's
own group. Each special function group should have a group role
called ENABLE. When ENABLE is 0, we can use the pin as a normal
digital I/O. Otherwise the special function takes control. Each pin
should be able to be accessed as an individual parameter. If the
device is intended to be used for user interfaces, several debounced
rising/falling edge counters should be implemented.</P>
<H3 CLASS="western">Group and Multicast addressing</H3>
<P CLASS="western">Normally group addressing would require devices to
be exactly the same or at least share the exact same parameter array
layout. However, there is a way around that. Information Broadcast
Messages contain an 8 character identifier and as such make no
reference to the layout of parameters on the slave. Whenever a slave
is to receive data that is likely to be shared among many slaves,
such as the current time or global power save settings, the slave
should accept that data as an information broadcast request, and not
as a parameter write.</P>
<H3 CLASS="western">Button Presses, Motion Sensors, and other Short
Events</H3>
<P CLASS="western">Since the slaves cannot report without being
asked, simply polling the actual sensor state would leave a large
possibility of missed events. Instead, maintain a rolling event
count, and simply check if it has changed since the last time you
polled it. Alternately, maintain a queue and place an entry in for
every event. This requires more memory but allows the events to have
attached data.</P>
<H3 CLASS="western">Procedure Calls</H3>
<P CLASS="western">While function calls are best implemennted as
reads with arguments, it is suggested that function calls that do not
return a value<BR>be implemented as write operations to give the
master the option of calling the procedure without waiting for
acknowledgement.</P>
<H2 CLASS="western">Glossary</H2>
<P CLASS="western">Gazebo <STRONG>Parameter: A variable, function, or
property exposed to the master by a slave device</STRONG></P>
<P CLASS="western">mUTF-8: Modified UTF-8. This variant allows
compatibility with null terminated strings.</P>
<P CLASS="western">8-N-1: Asynchronous serial with 8 data bits, 1
start bit, and 1 stop bit.</P>
<P CLASS="western"><BR><BR>
</P>
</BODY>
</HTML>